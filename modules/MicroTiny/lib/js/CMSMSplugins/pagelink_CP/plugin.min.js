tinymce.util.Tools.resolve('tinymce.PluginManager').add("pagelink_CP",function(e){function t(){var t,a,n,l,i,s,r,m,o,c={},p=e.selection,g=e.dom;function u(){(s=$(".tox-dialog").find('input[placeholder="FINDMEpage"]')).attr({placeholder:cmsms_tiny.prompt_page_place,title:cmsms_tiny.prompt_page_info})}if(t=p.getNode(),a=g.getParent(t,"a[href]"),c.page="",c.alias="",c.text=n=a?a.innerText||a.textContent:p.getContent({format:"text"}),c.target=a?g.getAttrib(a,"target"):"",c.classname=a?g.getAttrib(a,"class"):"",c.rel=a?g.getAttrib(a,"rel"):"",-1!==(r=a?g.getAttrib(a,"href"):"").indexOf("cms_selflink")){var _=r.match(/href=(.*)[\s\}]/);_.length>=2&&(c.alias=_[1].replace(/'/g,""),c.page=cmsms_tiny.loading_info,$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{alias:c.alias}}).done(function(e){e&&e.label?(c.page=e.label,c.alias=e.value,r="{cms_selflink href='"+c.alias+"'}"):(c.page=c.alias="",r=""),l.setData({page:c.page,alias:c.alias})}))}else r="";"IMG"===t.nodeName&&(c.text=n=" "),i=!1!==e.settings.target_list?{name:"target",type:"listbox",label:cmsms_tiny.prompt_target,items:(m=c.target,o=[{text:cmsms_tiny.target_none,value:""}],e.settings.target_list||o.push({text:cmsms_tiny.target_new_window,value:"_blank"}),tinymce.each(e.settings.target_list,function(e){o.push({text:e.text||e.title,value:e.value,selected:m===e.value})}),o)}:{},l=e.windowManager.open({title:cmsms_tiny.linker_heading,initialData:{page:c.page,alias:c.alias,text:c.text,target:c.target,classname:c.classname,rel:c.rel},body:{type:"tabpanel",tabs:[{title:cmsms_tiny.tab_general,name:"general",type:"form",items:[{name:"page",type:"input",inputMode:"text",label:cmsms_tiny.prompt_page,size:40,placeholder:"FINDMEpage"},{name:"alias",type:"input",inputMode:"text",label:cmsms_tiny.prompt_alias,disabled:!0,size:40,placeholder:cmsms_tiny.prompt_alias_info},{name:"text",type:"input",inputMode:"text",label:cmsms_tiny.prompt_text,size:40}]},{title:cmsms_tiny.tab_advanced,name:"advanced",type:"form",items:[i,{name:"classname",type:"input",inputMode:"text",label:cmsms_tiny.prompt_class,size:40},{name:"rel",type:"input",inputMode:"text",label:cmsms_tiny.prompt_rel,size:40}]}]},buttons:[{type:"cancel",text:"Cancel"},{type:"submit",text:"Save",primary:!0}],onChange:function(e,t){switch(t.name){case"page":var a=e.getData();a.page.length>2&&(a.page,$(".ui-autocomplete").css("z-index",7e4),$(".ui-helper-hidden-accessible").hide(),s.autocomplete({minLength:2,source:function(e,t){$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{term:e.term}}).done(function(e){t(e)})},focus:function(e,t){e.preventDefault()},select:function(e,t){e.preventDefault(),void 0!==t.item&&(l.setData({page:t.item.label,alias:t.item.value}),r="{cms_selflink href='"+t.item.value+"'}")}}));break;default:}},onTabChange:function(e,t){"general"===t.newTabName&&u()},onSubmit:function(t){var i,s=t.getData();s.page&&r?(s.text!==n?a?(e.trigger("focus"),a.innerHTML=s.text||s.page,g.setAttribs(a,{href:r,target:s.target?s.target:null,rel:s.rel?s.rel:null,class:s.classname?s.classname:null}),p.select(a)):(i=s.text||n||s.page,a=g.createHTML("a",{href:r,target:s.target?s.target:null,rel:s.rel?s.rel:null,class:s.classname?s.classname:null},i),e.insertContent(a)):(i=s.text||s.page||"EDITME",a=g.createHTML("a",{href:r,target:s.target?s.target:null,rel:s.rel?s.rel:null,class:s.classname?s.classname:null},i),e.insertContent(a)),l.close()):e.execCommand("unlink")}}),u()}function a(t){return function(t){var a=function(){return t.setDisabled(null===function(e,t){return(t=t||e.selection.getNode())?e.dom.select('a[href*="cms_selflink"]',t)[0]:e.dom.getParent(t,'a[href*="cms_selflink"]')}(e,e.selection.getNode()))};return a(),function(e,t){return e.on("NodeChange",t),function(){return e.off("NodeChange",t)}}(e,a)}}e.ui.registry.addMenuItem("pagelink_CP",{icon:"pagelink",onAction:t,onSetup:a,text:cmsms_tiny.linker_text+"..."}),e.ui.registry.addButton("pagelink_CP",{icon:"pagelink",onAction:t,onSetup:a,tooltip:cmsms_tiny.linker_title})});
