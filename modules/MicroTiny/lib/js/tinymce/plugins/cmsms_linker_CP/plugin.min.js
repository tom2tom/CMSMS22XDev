tinymce.PluginManager.add("cmsms_linker_CP",function(e){function t(){var t,a,n,l,s,i,r,m,c,o={},p=e.selection,u=e.dom;function g(){(i=$(".tox-dialog").find('input[placeholder="FINDMEpage"]')).attr({placeholder:cmsms_tiny.prompt_page_place,title:cmsms_tiny.prompt_page_info})}if(t=p.getNode(),a=u.getParent(t,"a[href]"),o.page="",o.alias="",o.text=n=a?a.innerText||a.textContent:p.getContent({format:"text"}),o.target=a?u.getAttrib(a,"target"):"",o.classname=a?u.getAttrib(a,"class"):"",o.rel=a?u.getAttrib(a,"rel"):"",-1!==(r=a?u.getAttrib(a,"href"):"").indexOf("cms_selflink")){var _=r.match(/href=(.*)[\s\}]/);_.length>=2&&(o.alias=_[1].replace(/'/g,""),o.page=cmsms_tiny.loading_info,$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{alias:o.alias}}).done(function(e){e&&e.label?(o.page=e.label,o.alias=e.value,r="{cms_selflink href='"+o.alias+"'}"):(o.page=o.alias="",r=""),l.setData({page:o.page,alias:o.alias})}))}else r="";"IMG"===t.nodeName&&(o.text=n=" "),s=!1!==e.settings.target_list?{name:"target",type:"listbox",label:cmsms_tiny.prompt_target,items:(m=o.target,c=[{text:cmsms_tiny.target_none,value:""}],e.settings.target_list||c.push({text:cmsms_tiny.target_new_window,value:"_blank"}),tinymce.each(e.settings.target_list,function(e){c.push({text:e.text||e.title,value:e.value,selected:m===e.value})}),c)}:{},l=e.windowManager.open({title:cmsms_tiny.linker_heading,initialData:{page:o.page,alias:o.alias,text:o.text,target:o.target,classname:o.classname,rel:o.rel},body:{type:"tabpanel",tabs:[{title:cmsms_tiny.tab_general,name:"general",type:"form",items:[{name:"page",type:"input",inputMode:"text",label:cmsms_tiny.prompt_page,size:40,placeholder:"FINDMEpage"},{name:"alias",type:"input",inputMode:"text",label:cmsms_tiny.prompt_alias,disabled:!0,size:40,placeholder:cmsms_tiny.prompt_alias_info},{name:"text",type:"input",inputMode:"text",label:cmsms_tiny.prompt_text,size:40}]},{title:cmsms_tiny.tab_advanced,name:"advanced",type:"form",items:[s,{name:"classname",type:"input",inputMode:"text",label:cmsms_tiny.prompt_class,size:40},{name:"rel",type:"input",inputMode:"text",label:cmsms_tiny.prompt_rel,size:40}]}]},buttons:[{type:"cancel",text:"Cancel"},{type:"submit",text:"Save",primary:!0}],onChange:function(e,t){switch(t.name){case"page":var a=e.getData();a.page.length>2&&(a.page,$(".ui-autocomplete").css("z-index",7e4),$(".ui-helper-hidden-accessible").hide(),i.autocomplete({minLength:2,source:function(e,t){$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{term:e.term}}).done(function(e){t(e)})},focus:function(e,t){e.preventDefault()},select:function(e,t){e.preventDefault(),void 0!==t.item&&(l.setData({page:t.item.label,alias:t.item.value}),r="{cms_selflink href='"+t.item.value+"'}")}}));break;default:}},onTabChange:function(e,t){"general"===t.newTabName&&g()},onSubmit:function(t){var s,i=t.getData();i.page&&r?(i.text!==n?a?(e.trigger("focus"),a.innerHTML=i.text||i.page,u.setAttribs(a,{href:r,target:i.target?i.target:null,rel:i.rel?i.rel:null,class:i.classname?i.classname:null}),p.select(a)):(s=i.text||n||i.page,a=u.createHTML("a",{href:r,target:i.target?i.target:null,rel:i.rel?i.rel:null,class:i.classname?i.classname:null},s),e.insertContent(a)):(s=i.text||i.page||"EDITME",a=u.createHTML("a",{href:r,target:i.target?i.target:null,rel:i.rel?i.rel:null,class:i.classname?i.classname:null},s),e.insertContent(a)),l.close()):e.execCommand("unlink")}}),g()}function a(e){return function(t){var a=function(){return t.setDisabled(null===function(e,t){return(t=t||e.selection.getNode())?e.dom.select('a[href*="cms_selflink"]',t)[0]:e.dom.getParent(t,'a[href*="cms_selflink"]')}(e,e.selection.getNode()))};return a(),function(e,t){return e.on("NodeChange",t),function(){return e.off("NodeChange",t)}}(e,a)}}e.ui.registry.addMenuItem("cmsms_linker_CP",{icon:"pagelink",onAction:t,onSetup:a(e),stateSelector:'a[href*="cms_selflink"]',text:cmsms_tiny.linker_text+"..."}),e.ui.registry.addButton("cmsms_linker_CP",{icon:"pagelink",onAction:t,onSetup:a(e),stateSelector:'a[href*="cms_selflink"]',tooltip:cmsms_tiny.linker_title})});
