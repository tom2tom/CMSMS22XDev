tinymce.PluginManager.add("cmsms_linker_CP",function(e){function t(){var t,a,n,l,i,s,r,m,o={},c=e.selection,p=e.dom;function u(){(i=$(".tox-dialog").find('input[placeholder="FINDMEpage"]')).attr({placeholder:cmsms_tiny.prompt_page_place,title:cmsms_tiny.prompt_page_info})}if(t=c.getNode(),a=p.getParent(t,"a[href]"),o.page="",o.alias="",o.text=n=a?a.innerText||a.textContent:c.getContent({format:"text"}),o.target=a?p.getAttrib(a,"target"):"",o.classname=a?p.getAttrib(a,"class"):"",o.rel=a?p.getAttrib(a,"rel"):"",-1!==(s=a?p.getAttrib(a,"href"):"").indexOf("cms_selflink")){var g=s.match(/href=(.*)[\s\}]/);g.length>=2&&(o.alias=g[1].replace(/'/g,""),o.page=cmsms_tiny.loading_info,$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{alias:o.alias}}).done(function(e){e&&e.label?(o.page=e.label,o.alias=e.value,s="{cms_selflink href='"+o.alias+"'}"):(o.page=o.alias="",s=""),l.setData({page:o.page,alias:o.alias})}))}else s="";"IMG"===t.nodeName&&(o.text=n=" "),l=e.windowManager.open({title:cmsms_tiny.linker_heading,initialData:{page:o.page,alias:o.alias,text:o.text,target:o.target,classname:o.classname,rel:o.rel},body:{type:"tabpanel",tabs:[{title:cmsms_tiny.tab_general,name:"general",type:"form",items:[{name:"page",type:"input",inputMode:"text",label:cmsms_tiny.prompt_page,size:40,placeholder:"FINDMEpage"},{name:"alias",type:"input",inputMode:"text",label:cmsms_tiny.prompt_alias,disabled:!0,size:40,placeholder:cmsms_tiny.prompt_alias_info},{name:"text",type:"input",inputMode:"text",label:cmsms_tiny.prompt_text,size:40}]},{title:cmsms_tiny.tab_advanced,name:"advanced",type:"form",items:[{name:"target",type:"listbox",label:cmsms_tiny.prompt_target,items:(r=o.target,m=[{text:cmsms_tiny.target_none,value:""}],e.options.isRegistered("target_list")&&e.options.isSet("target_list")?tinymce.each(e.options.get("target_list"),function(e){m.push({text:e.text||e.title,value:e.value,selected:r===e.value})}):m.push({text:cmsms_tiny.target_new_window,value:"_blank"}),m)},{name:"classname",type:"input",inputMode:"text",label:cmsms_tiny.prompt_class,size:40},{name:"rel",type:"input",inputMode:"text",label:cmsms_tiny.prompt_rel,size:40}]}]},buttons:[{type:"cancel",text:"Cancel"},{type:"submit",text:"Save",primary:!0}],onChange:function(e,t){switch(t.name){case"page":var a=e.getData();a.page.length>2&&(a.page,$(".ui-autocomplete").css("z-index",7e4),$(".ui-helper-hidden-accessible").hide(),i.autocomplete({minLength:2,source:function(e,t){$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{term:e.term}}).done(function(e){t(e)})},focus:function(e,t){e.preventDefault()},select:function(e,t){e.preventDefault(),void 0!==t.item&&(l.setData({page:t.item.label,alias:t.item.value}),s="{cms_selflink href='"+t.item.value+"'}")}}));break;default:}},onTabChange:function(e,t){"general"===t.newTabName&&u()},onSubmit:function(t){var i,r=t.getData();r.page&&s?(r.text!==n?a?(e.trigger("focus"),a.innerHTML=r.text||r.page,p.setAttribs(a,{href:s,target:r.target?r.target:null,rel:r.rel?r.rel:null,class:r.classname?r.classname:null}),c.select(a)):(i=r.text||n||r.page,a=p.createHTML("a",{href:s,target:r.target?r.target:null,rel:r.rel?r.rel:null,class:r.classname?r.classname:null},i),e.insertContent(a)):(i=r.text||r.page||"EDITME",a=p.createHTML("a",{href:s,target:r.target?r.target:null,rel:r.rel?r.rel:null,class:r.classname?r.classname:null},i),e.insertContent(a)),l.close()):e.execCommand("unlink")}}),u()}function a(t){return function(t){var a=function(){return t.setEnabled(null!==function(e,t){return(t=t||e.selection.getNode())?e.dom.select('a[href*="cms_selflink"]',t)[0]:e.dom.getParent(t,'a[href*="cms_selflink"]')}(e,e.selection.getNode()))};return a(),function(e,t){return e.on("NodeChange",t),function(){return e.off("NodeChange",t)}}(e,a)}}e.ui.registry.addMenuItem("cmsms_linker_CP",{icon:"pagelink",onAction:t,onSetup:a,stateSelector:'a[href*="cms_selflink"]',text:cmsms_tiny.linker_text+"..."}),e.ui.registry.addButton("cmsms_linker_CP",{icon:"pagelink",onAction:t,onSetup:a,stateSelector:'a[href*="cms_selflink"]',tooltip:cmsms_tiny.linker_title})});