tinymce.PluginManager.add("cmsms_filepicker",function(e){return e.settings.file_picker_type="file image media",e.settings.file_picker_callback=function(e,t,i){var n,l,r;!function(e){n=600,l=900,e.innerHeight<650&&(n=Math.max(.8*e.innerHeight,250)),e.innerWidth<950&&(l=Math.max(.8*e.innerWidth,250))}(window);var c="i"+(new Date).getTime().toString(16);tinymce.activeEditor.dom.setAttrib(tinyMCE.activeEditor.dom.select("html"),"data-cmsfp-instance",c),top.document.CMSFileBrowser||(top.document.CMSFileBrowser={type:i.filetype});top.document.CMSFileBrowser.onselect=function(t,n){function l(e){var t,i,n,l=e.charAt(e.length-1);return t="/"!==l&&"\\"!==l?e:e.slice(0,-1),n=t.replace(/^.*[/\\]/g,""),(i=n.lastIndexOf("."))>0?n.slice(0,i):n}n=cms_data.root_url+n;var c={};"file"===i.filetype?c.text=l(n):"image"===i.filetype&&(c.alt=l(n)),e(n,c),top.document.CMSFileBrowser.onselect=null,r.close()};var o="image"===i.filetype?"imagebrowser_title":"filebrowser_title",a=cmsms_tiny.filepicker_url+"&m1_inst="+encodeURIComponent(c)+"&m1_type="+i.filetype+"&m1_useprefix=1";r=tinymce.activeEditor.windowManager.open({title:cmsms_tiny[o],file:a,classes:"filepicker",height:n,width:l,inline:1,resizable:!0,maximizable:!0},{onFileSelected:function(e){console.debug("woot got callback with "+e)}})},!1});