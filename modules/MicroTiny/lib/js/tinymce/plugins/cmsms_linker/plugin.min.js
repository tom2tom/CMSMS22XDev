tinymce.PluginManager.add("cmsms_linker",function(e,t){function a(){var t,a,n,s,l,i,m,r,c,o,u,g,p,_={},f=e.selection,h=e.dom;function d(e){$(".ui-autocomplete").css("z-index",7e4),$(".ui-helper-hidden-accessible").hide();var t=document.getElementById(e);$(t).autocomplete({minLength:2,source:function(e,t){$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{term:e.term}}).done(function(e){t(e)})},focus:function(e,t){e.preventDefault()},select:function(e,a){void 0!==a.item&&($(t).val(a.item.label),$(".mce-cmsms-linker-alias").val(a.item.value),$(".mce-cmsms-linker-href").val("{cms_selflink href='"+a.item.value+"'}")),e.preventDefault()}})}t=f.getNode(),a=h.getParent(t,"a[href]"),_.page="",_.alias="",_.text=n=a?a.innerText||a.textContent:f.getContent({format:"text"}),_.href=a?h.getAttrib(a,"href"):"",_.target=a?h.getAttrib(a,"target"):"",_.classname=a?h.getAttrib(a,"class"):"",_.rel=a?h.getAttrib(a,"rel"):"",-1!==_.href.indexOf("cms_selflink")&&(u=_.href.match(/href=(.*)[\s\}]/)).length>=2&&(_.alias=u[1].replace(/'/g,""),_.page=cmsms_tiny.loading_info,$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{alias:_.alias}}).done(function(e){_.page=_.href="",$(".mce-cmsms-linker-page").val(""),$(".mce-cmsms-linker-alias").val(""),$(".mce-cmsms-linker-href").val(""),e&&e.label&&(_.page=e.label,_.href="{cms_selflink href='"+_.alias+"'}",$(".mce-cmsms-linker-page").val(_.page),$(".mce-cmsms-linker-alias").val(_.alias),$(".mce-cmsms-linker-href").val(_.href))})),"IMG"===t.nodeName&&(_.text=n=" "),!1!==e.settings.target_list&&(r={name:"target",type:"listbox",label:cmsms_tiny.prompt_target,values:(g=_.target,p=[{text:cmsms_tiny.target_none,value:""}],e.settings.target_list||p.push({text:cmsms_tiny.target_new_window,value:"_blank"}),tinymce.each(e.settings.target_list,function(e){p.push({text:e.text||e.title,value:e.value,selected:g===e.value})}),p)}),l={name:"page",type:"textbox",size:40,classes:"cmsms-linker-page",tooltip:cmsms_tiny.prompt_page_info,label:cmsms_tiny.prompt_page,onkeyup:function(){d(this._id)},onchange:function(){d(this._id)}},i={name:"alias",disabled:!0,type:"textbox",size:40,label:cmsms_tiny.prompt_alias,tooltip:cmsms_tiny.prompt_alias_info,classes:"cmsms-linker-alias"},m={name:"text",type:"textbox",size:40,label:cmsms_tiny.prompt_text,onchange:function(){_.text=this.value()},onkeyup:function(){_.text=this.value()}},c={name:"classname",type:"textbox",size:40,label:cmsms_tiny.prompt_class,onchange:function(){_.classname=this.value()},onkeyup:function(){_.classname=this.value()}},o={name:"rel",type:"textbox",size:40,label:cmsms_tiny.prompt_rel,onchange:function(){_.rel=this.value()},onkeyup:function(){_.rel=this.value()}},s=e.windowManager.open({title:cmsms_tiny.linker_heading,data:_,bodyType:"tabpanel",body:[{title:cmsms_tiny.tab_general,type:"form",items:[l,i,m,{name:"href",type:"textbox",classes:"cmsms-linker-href",size:100,hidden:!0,value:"{cms_selflink href='"+_.alias+"'}"}]},{title:cmsms_tiny.tab_advanced,type:"form",items:[r,c,o]}],onSubmit:function(){var t=s.toJSON(),l=t.href,i=t.page;l&&i?t.text!==n?a?(e.trigger("focus"),a.innerHTML=t.text,h.setAttribs(a,{href:l,target:t.target?t.target:null,rel:t.rel?t.rel:null,class:t.classname?t.classname:null}),f.select(a)):e.insertContent(h.createHTML("a",{href:l,target:t.target?t.target:null,rel:t.rel?t.rel:null,class:t.classname?t.classname:null},t.text)):e.execCommand("mceInsertLink",!1,{href:l,target:t.target,rel:t.rel?t.rel:null,class:t.classname?t.classname:null}):e.execCommand("unlink")}})}e.addButton("cmsms_linker",{title:cmsms_tiny.linker_title,icon:"link",image:cmsms_tiny.linker_image,onclick:a,stateSelector:"a[href]"}),e.addMenuItem("cmsms_linker",{text:cmsms_tiny.linker_text,title:cmsms_tiny.linker_title,image:cmsms_tiny.linker_image,stateSelector:"a[href]",context:"insert",prependToContext:!0,onclick:a})});